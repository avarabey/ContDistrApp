<svg xmlns="http://www.w3.org/2000/svg" width="1600" height="920" viewBox="0 0 1600 920">
  <defs>
    <marker id="arr" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="8" markerHeight="8" orient="auto-start-reverse">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#0f172a"/>
    </marker>
    <style>
      .title { font: 700 28px Arial, sans-serif; fill: #0f172a; }
      .sub { font: 500 14px Arial, sans-serif; fill: #334155; }
      .zone { fill: #f8fafc; stroke: #94a3b8; stroke-width: 2; rx: 12; }
      .box { fill: #ffffff; stroke: #334155; stroke-width: 1.8; rx: 9; }
      .h { font: 700 16px Arial, sans-serif; fill: #0f172a; }
      .p { font: 500 12px Arial, sans-serif; fill: #334155; }
      .edge { stroke: #0f172a; stroke-width: 1.8; fill: none; marker-end: url(#arr); }
      .edge2 { stroke: #475569; stroke-width: 1.4; stroke-dasharray: 6 5; fill: none; marker-end: url(#arr); }
      .e { font: 500 12px Arial, sans-serif; fill: #0f172a; }
    </style>
  </defs>

  <rect width="1600" height="920" fill="#ffffff"/>
  <text x="34" y="44" class="title">Контекстная диаграмма платформы</text>
  <text x="34" y="66" class="sub">Кто интегрируется с сервисом и по каким контрактам</text>

  <rect x="30" y="90" width="300" height="770" class="zone"/>
  <text x="46" y="120" class="h">Внешний контур</text>

  <rect x="50" y="145" width="260" height="84" class="box"/>
  <text x="66" y="176" class="h">MDM-источник</text>
  <text x="66" y="198" class="p">Публикация изменений справочников</text>

  <rect x="50" y="255" width="260" height="84" class="box"/>
  <text x="66" y="286" class="h">Операционный backoffice</text>
  <text x="66" y="308" class="p">Ручные обновления через REST</text>

  <rect x="50" y="365" width="260" height="84" class="box"/>
  <text x="66" y="396" class="h">Бизнес-сервисы</text>
  <text x="66" y="418" class="p">Чтение справочников с высокой нагрузкой</text>

  <rect x="50" y="475" width="260" height="84" class="box"/>
  <text x="66" y="506" class="h">IAM / Identity Provider</text>
  <text x="66" y="528" class="p">JWT claim с tenant_id</text>

  <rect x="50" y="585" width="260" height="84" class="box"/>
  <text x="66" y="616" class="h">Observability stack</text>
  <text x="66" y="638" class="p">Метрики, логи, трассировки</text>

  <rect x="50" y="695" width="260" height="84" class="box"/>
  <text x="66" y="726" class="h">Платформенная SRE-команда</text>
  <text x="66" y="748" class="p">Эксплуатация и инциденты</text>

  <rect x="360" y="90" width="820" height="770" class="zone"/>
  <text x="376" y="120" class="h">Граница платформы справочников</text>

  <rect x="390" y="150" width="350" height="98" class="box"/>
  <text x="406" y="184" class="h">refdata-command-api</text>
  <text x="406" y="206" class="p">POST /updates, GET /updates/{eventId}</text>
  <text x="406" y="226" class="p">Режимы ASYNC и WAIT_COMMIT</text>

  <rect x="780" y="150" width="370" height="98" class="box"/>
  <text x="796" y="184" class="h">refdata-kafka-adapter</text>
  <text x="796" y="206" class="p">Нормализует внешний формат событий</text>
  <text x="796" y="226" class="p">Пишет во внутренний commands topic</text>

  <rect x="390" y="275" width="760" height="88" class="box"/>
  <text x="406" y="308" class="h">Kafka: refdata.commands (key = tenantId:dictCode)</text>
  <text x="406" y="331" class="p">Гарантия порядка в рамках пары tenant + dictionary</text>

  <rect x="390" y="390" width="370" height="120" class="box"/>
  <text x="406" y="425" class="h">refdata-apply-service</text>
  <text x="406" y="447" class="p">Идемпотентное применение DELTA/SNAPSHOT</text>
  <text x="406" y="467" class="p">Обновление dictionary_meta.version</text>
  <text x="406" y="487" class="p">Статусы update_request + outbox</text>

  <rect x="780" y="390" width="370" height="120" class="box"/>
  <text x="796" y="425" class="h">refdata-query-api</text>
  <text x="796" y="447" class="p">In-memory cache по (tenantId, dictCode)</text>
  <text x="796" y="467" class="p">Version barrier через X-Min-Version</text>
  <text x="796" y="487" class="p">Fallback в PostgreSQL при строгом чтении</text>

  <rect x="390" y="540" width="370" height="98" class="box"/>
  <text x="406" y="574" class="h">refdata-outbox-relay</text>
  <text x="406" y="596" class="p">PUBLISH инвалидаций + XADD recovery-событий</text>
  <text x="406" y="616" class="p">Только после commit транзакции</text>

  <rect x="780" y="540" width="370" height="98" class="box"/>
  <text x="796" y="574" class="h">Redis Cluster</text>
  <text x="796" y="596" class="p">Pub/Sub: refdata:inv:pub</text>
  <text x="796" y="616" class="p">Streams: refdata:inv:stream</text>

  <rect x="390" y="670" width="760" height="88" class="box"/>
  <text x="406" y="704" class="h">PostgreSQL</text>
  <text x="406" y="726" class="p">Канонический источник данных и версий + служебные таблицы</text>

  <rect x="1210" y="90" width="360" height="770" class="zone"/>
  <text x="1226" y="120" class="h">Инфраструктурный контур</text>

  <rect x="1230" y="165" width="320" height="96" class="box"/>
  <text x="1246" y="198" class="h">Kubernetes + Istio</text>
  <text x="1246" y="220" class="p">mTLS, HPA, anti-affinity, PDB</text>
  <text x="1246" y="240" class="p">Минимум 3 реплики каждого сервиса</text>

  <rect x="1230" y="285" width="320" height="96" class="box"/>
  <text x="1246" y="318" class="h">Контур безопасности</text>
  <text x="1246" y="340" class="p">Tenant-изоляция и проверка auth-контекста</text>
  <text x="1246" y="360" class="p">JWT и mTLS для доверенных клиентов</text>

  <rect x="1230" y="405" width="320" height="96" class="box"/>
  <text x="1246" y="438" class="h">SLO-дашборд</text>
  <text x="1246" y="460" class="p">Freshness p95/p99, lag и ошибки reload</text>
  <text x="1246" y="480" class="p">Алерты и runbook-процедуры</text>

  <line x1="310" y1="297" x2="390" y2="200" class="edge"/>
  <text x="316" y="258" class="e">REST-команда</text>

  <line x1="310" y1="187" x2="780" y2="200" class="edge"/>
  <text x="466" y="176" class="e">Kafka-событие</text>

  <line x1="310" y1="407" x2="780" y2="447" class="edge"/>
  <text x="484" y="390" class="e">Запрос чтения</text>

  <line x1="310" y1="517" x2="390" y2="200" class="edge2"/>
  <text x="318" y="485" class="e">JWT tenant_id</text>

  <line x1="740" y1="198" x2="780" y2="319" class="edge"/>
  <line x1="965" y1="248" x2="965" y2="275" class="edge"/>
  <line x1="770" y1="319" x2="575" y2="390" class="edge"/>

  <line x1="575" y1="510" x2="575" y2="540" class="edge"/>
  <line x1="575" y1="638" x2="575" y2="670" class="edge"/>
  <line x1="965" y1="510" x2="965" y2="540" class="edge"/>
  <line x1="965" y1="638" x2="965" y2="670" class="edge"/>

  <line x1="780" y1="447" x2="760" y2="447" class="edge2"/>
  <text x="642" y="437" class="e">fallback</text>

  <line x1="1150" y1="318" x2="780" y2="447" class="edge"/>
  <text x="984" y="304" class="e">инвалидация / recovery</text>

  <line x1="1550" y1="453" x2="310" y2="633" class="edge2"/>
  <text x="1380" y="620" class="e">экспорт телеметрии</text>

  <line x1="1550" y1="213" x2="1120" y2="213" class="edge2"/>
  <line x1="1550" y1="333" x2="1120" y2="333" class="edge2"/>
  <line x1="1550" y1="453" x2="1120" y2="453" class="edge2"/>
</svg>
