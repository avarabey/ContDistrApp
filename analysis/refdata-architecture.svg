<svg xmlns="http://www.w3.org/2000/svg" width="1700" height="980" viewBox="0 0 1700 980">
  <defs>
    <marker id="arrow" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#1f2937"/>
    </marker>
    <style>
      .title { font: 700 28px Arial, sans-serif; fill: #111827; }
      .group { fill: #f8fafc; stroke: #94a3b8; stroke-width: 2; rx: 12; }
      .box { fill: #ffffff; stroke: #334155; stroke-width: 1.6; rx: 8; }
      .group-label { font: 700 18px Arial, sans-serif; fill: #1e293b; }
      .label { font: 600 14px Arial, sans-serif; fill: #0f172a; }
      .small { font: 500 12px Arial, sans-serif; fill: #334155; }
      .edge { stroke: #1f2937; stroke-width: 1.8; fill: none; marker-end: url(#arrow); }
      .edge-label { font: 500 12px Arial, sans-serif; fill: #111827; }
    </style>
  </defs>

  <rect x="0" y="0" width="1700" height="980" fill="#ffffff"/>
  <text x="40" y="48" class="title">Архитектура платформы справочников</text>

  <rect x="30" y="90" width="270" height="290" class="group"/>
  <text x="46" y="120" class="group-label">Внешние системы</text>
  <rect x="50" y="140" width="230" height="58" class="box"/>
  <text x="66" y="173" class="label">Клиент записи</text>
  <rect x="50" y="220" width="230" height="58" class="box"/>
  <text x="66" y="253" class="label">Клиент чтения</text>
  <rect x="50" y="300" width="230" height="58" class="box"/>
  <text x="66" y="333" class="label">Внешний Kafka producer</text>

  <rect x="340" y="90" width="360" height="330" class="group"/>
  <text x="356" y="120" class="group-label">Контур приёма команд</text>
  <rect x="360" y="140" width="320" height="80" class="box"/>
  <text x="376" y="169" class="label">refdata-command-api</text>
  <text x="376" y="190" class="small">POST /updates, GET /updates/{eventId}</text>
  <rect x="360" y="240" width="320" height="62" class="box"/>
  <text x="376" y="276" class="label">refdata-kafka-adapter</text>
  <rect x="360" y="322" width="320" height="80" class="box"/>
  <text x="376" y="351" class="label">Kafka: refdata.commands</text>
  <text x="376" y="372" class="small">key = {tenantId}:{dictCode}</text>

  <rect x="740" y="90" width="400" height="380" class="group"/>
  <text x="756" y="120" class="group-label">Контур применения</text>
  <rect x="760" y="140" width="360" height="95" class="box"/>
  <text x="776" y="170" class="label">refdata-apply-service</text>
  <text x="776" y="191" class="small">DELTA/SNAPSHOT, идемпотентность</text>
  <text x="776" y="212" class="small">проверка sourceRevision</text>
  <rect x="760" y="255" width="360" height="95" class="box"/>
  <text x="776" y="285" class="label">PostgreSQL</text>
  <text x="776" y="306" class="small">dictionary_meta, processed_event,</text>
  <text x="776" y="327" class="small">update_request, outbox_event + бизнес-таблицы</text>
  <rect x="760" y="370" width="360" height="80" class="box"/>
  <text x="776" y="400" class="label">refdata-outbox-relay</text>
  <text x="776" y="421" class="small">Публикация инвалидаций после commit</text>

  <rect x="1180" y="170" width="300" height="250" class="group"/>
  <text x="1196" y="200" class="group-label">Сигнализация</text>
  <rect x="1200" y="230" width="260" height="70" class="box"/>
  <text x="1216" y="259" class="label">Redis Pub/Sub</text>
  <text x="1216" y="280" class="small">refdata:inv:pub</text>
  <rect x="1200" y="320" width="260" height="70" class="box"/>
  <text x="1216" y="349" class="label">Redis Streams</text>
  <text x="1216" y="370" class="small">refdata:inv:stream</text>

  <rect x="530" y="540" width="1030" height="300" class="group"/>
  <text x="546" y="570" class="group-label">Контур чтения</text>
  <rect x="560" y="600" width="960" height="120" class="box"/>
  <text x="580" y="634" class="label">refdata-query-api</text>
  <text x="580" y="656" class="small">in-memory cache по (tenantId, dictCode), single-flight, atomic swap</text>
  <text x="580" y="678" class="small">version barrier (X-Min-Version), fallback в PostgreSQL при строгом чтении</text>

  <line x1="280" y1="169" x2="360" y2="180" class="edge"/>
  <text x="286" y="156" class="edge-label">REST обновление</text>

  <line x1="280" y1="332" x2="360" y2="271" class="edge"/>
  <text x="286" y="305" class="edge-label">внешний topic</text>

  <line x1="520" y1="220" x2="520" y2="322" class="edge"/>
  <text x="526" y="276" class="edge-label">нормализация</text>

  <line x1="520" y1="302" x2="520" y2="322" class="edge"/>

  <line x1="680" y1="362" x2="760" y2="188" class="edge"/>
  <text x="690" y="320" class="edge-label">ordered consume</text>

  <line x1="940" y1="235" x2="940" y2="255" class="edge"/>
  <text x="946" y="248" class="edge-label">tx apply + version</text>

  <line x1="940" y1="350" x2="940" y2="370" class="edge"/>
  <text x="946" y="365" class="edge-label">outbox poll</text>

  <line x1="1120" y1="410" x2="1200" y2="265" class="edge"/>
  <text x="1128" y="338" class="edge-label">PUBLISH</text>

  <line x1="1120" y1="410" x2="1200" y2="355" class="edge"/>
  <text x="1130" y="390" class="edge-label">XADD</text>

  <line x1="280" y1="249" x2="560" y2="660" class="edge"/>
  <text x="320" y="480" class="edge-label">чтение справочника (опц. X-Min-Version)</text>

  <line x1="1200" y1="265" x2="1030" y2="600" class="edge"/>
  <text x="1120" y="500" class="edge-label">инвалидация</text>

  <line x1="1200" y1="355" x2="1100" y2="600" class="edge"/>
  <text x="1114" y="550" class="edge-label">recovery (XREADGROUP/XACK)</text>

  <line x1="940" y1="600" x2="940" y2="350" class="edge"/>
  <text x="946" y="494" class="edge-label">reload/fallback к PostgreSQL</text>
</svg>
