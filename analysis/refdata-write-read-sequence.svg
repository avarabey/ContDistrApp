<svg xmlns="http://www.w3.org/2000/svg" width="1800" height="1040" viewBox="0 0 1800 1040">
  <defs>
    <marker id="arr" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="8" markerHeight="8" orient="auto-start-reverse">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#0f172a"/>
    </marker>
    <style>
      .title { font: 700 28px Arial, sans-serif; fill: #0f172a; }
      .sub { font: 500 14px Arial, sans-serif; fill: #334155; }
      .actor { fill: #eef2ff; stroke: #64748b; stroke-width: 1.8; rx: 8; }
      .a { font: 700 14px Arial, sans-serif; fill: #0f172a; }
      .life { stroke: #94a3b8; stroke-width: 1.4; stroke-dasharray: 6 6; }
      .msg { stroke: #0f172a; stroke-width: 1.8; fill: none; marker-end: url(#arr); }
      .note { fill: #f8fafc; stroke: #94a3b8; stroke-width: 1.2; rx: 6; }
      .t { font: 500 12px Arial, sans-serif; fill: #1e293b; }
      .section { fill: #ecfeff; stroke: #0891b2; stroke-width: 1.2; rx: 8; }
      .s { font: 700 13px Arial, sans-serif; fill: #0c4a6e; }
    </style>
  </defs>

  <rect width="1800" height="1040" fill="#ffffff"/>
  <text x="36" y="44" class="title">Последовательность записи и чтения</text>
  <text x="36" y="66" class="sub">Сценарии ASYNC/WAIT_COMMIT и строгий барьер X-Min-Version</text>

  <rect x="40" y="95" width="170" height="42" class="actor"/>
  <text x="62" y="121" class="a">Клиент</text>
  <line x1="125" y1="138" x2="125" y2="980" class="life"/>

  <rect x="250" y="95" width="200" height="42" class="actor"/>
  <text x="270" y="121" class="a">command-api</text>
  <line x1="350" y1="138" x2="350" y2="980" class="life"/>

  <rect x="490" y="95" width="170" height="42" class="actor"/>
  <text x="522" y="121" class="a">Kafka</text>
  <line x1="575" y1="138" x2="575" y2="980" class="life"/>

  <rect x="700" y="95" width="210" height="42" class="actor"/>
  <text x="718" y="121" class="a">apply-service</text>
  <line x1="805" y1="138" x2="805" y2="980" class="life"/>

  <rect x="950" y="95" width="190" height="42" class="actor"/>
  <text x="984" y="121" class="a">PostgreSQL</text>
  <line x1="1045" y1="138" x2="1045" y2="980" class="life"/>

  <rect x="1180" y="95" width="190" height="42" class="actor"/>
  <text x="1216" y="121" class="a">outbox-relay</text>
  <line x1="1275" y1="138" x2="1275" y2="980" class="life"/>

  <rect x="1410" y="95" width="170" height="42" class="actor"/>
  <text x="1454" y="121" class="a">Redis</text>
  <line x1="1495" y1="138" x2="1495" y2="980" class="life"/>

  <rect x="1620" y="95" width="140" height="42" class="actor"/>
  <text x="1638" y="121" class="a">query-api</text>
  <line x1="1690" y1="138" x2="1690" y2="980" class="life"/>

  <rect x="36" y="162" width="1728" height="34" class="section"/>
  <text x="54" y="184" class="s">A. Путь записи</text>

  <line x1="125" y1="225" x2="350" y2="225" class="msg"/>
  <text x="140" y="217" class="t">POST /updates (ASYNC или WAIT_COMMIT)</text>

  <line x1="350" y1="255" x2="575" y2="255" class="msg"/>
  <text x="382" y="247" class="t">публикация refdata.commands key=tenant:dict</text>

  <line x1="575" y1="285" x2="805" y2="285" class="msg"/>
  <text x="632" y="277" class="t">консюм события с порядком по key</text>

  <line x1="805" y1="315" x2="1045" y2="315" class="msg"/>
  <text x="834" y="307" class="t">TX: apply DELTA/SNAPSHOT + bump dictionary_meta.version</text>

  <line x1="1045" y1="345" x2="805" y2="345" class="msg"/>
  <text x="840" y="337" class="t">commit ok + committedVersion</text>

  <line x1="805" y1="375" x2="1045" y2="375" class="msg"/>
  <text x="846" y="367" class="t">update_request(COMMITTED/FAILED) + outbox row</text>

  <line x1="1045" y1="405" x2="1275" y2="405" class="msg"/>
  <text x="1084" y="397" class="t">опрос outbox</text>

  <line x1="1275" y1="435" x2="1495" y2="435" class="msg"/>
  <text x="1310" y="427" class="t">PUBLISH + XADD инвалидации</text>

  <line x1="1495" y1="465" x2="1690" y2="465" class="msg"/>
  <text x="1530" y="457" class="t">событие {tenant,dict,version}</text>

  <line x1="1690" y1="495" x2="1045" y2="495" class="msg"/>
  <text x="1390" y="487" class="t">single-flight reload + atomic swap</text>

  <rect x="60" y="530" width="500" height="78" class="note"/>
  <text x="78" y="556" class="t">ASYNC: ответ 202 + eventId + statusUrl.</text>
  <text x="78" y="577" class="t">Клиент опрашивает GET /updates/{eventId} до COMMITTED.</text>

  <rect x="590" y="530" width="640" height="78" class="note"/>
  <text x="608" y="556" class="t">WAIT_COMMIT: ожидание до waitCommitTimeoutMs.</text>
  <text x="608" y="577" class="t">200 + committedVersion или 202 + eventId при timeout.</text>

  <rect x="36" y="638" width="1728" height="34" class="section"/>
  <text x="54" y="660" class="s">B. Строгое чтение после записи</text>

  <line x1="125" y1="705" x2="1690" y2="705" class="msg"/>
  <text x="146" y="697" class="t">GET /dictionaries/... с X-Min-Version = committedVersion</text>

  <line x1="1690" y1="735" x2="1690" y2="770" class="msg"/>
  <text x="1700" y="754" class="t">если localVersion >= X-Min-Version: чтение из памяти</text>

  <line x1="1690" y1="800" x2="1045" y2="800" class="msg"/>
  <text x="1320" y="792" class="t">если версия ниже: проверка dictionary_meta.version в primary</text>

  <line x1="1045" y1="830" x2="1690" y2="830" class="msg"/>
  <text x="1288" y="822" class="t">version >= min: fallback read + запуск reload</text>

  <line x1="1690" y1="860" x2="125" y2="860" class="msg"/>
  <text x="440" y="852" class="t">ответ: X-Dict-Version, X-Data-Source=memory|postgres_fallback</text>

  <rect x="60" y="890" width="640" height="78" class="note"/>
  <text x="78" y="916" class="t">Если версия в primary меньше барьера, вернуть 409 VERSION_NOT_COMMITTED.</text>
  <text x="78" y="937" class="t">Старые данные в строгом режиме не выдаются.</text>
</svg>
