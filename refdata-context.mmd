flowchart LR
  subgraph EXT["Внешний контур"]
    MDM["MDM-источник"]
    OPS["Операционный backoffice"]
    BS["Бизнес-сервисы"]
    IAM["Identity Provider"]
    OBS["Observability stack"]
  end

  subgraph PLATFORM["Платформа справочников"]
    CA["command-api"]
    KA["kafka-adapter"]
    KC[("Kafka refdata.commands")]
    AS["apply-service"]
    OR["outbox-relay"]
    QA["query-api"]
    PG[("PostgreSQL")]
    R[("Redis Cluster")]
  end

  subgraph INFRA["Инфраструктура"]
    K8S["Kubernetes + Istio"]
    SEC["Tenant-изоляция / JWT / mTLS"]
  end

  MDM -->|Kafka события| KA
  OPS -->|REST update| CA
  BS -->|REST чтение| QA
  IAM -.->|tenant_id claim| CA
  IAM -.->|tenant_id claim| QA

  CA --> KC
  KA --> KC
  KC --> AS
  AS --> PG
  PG --> OR
  OR --> R
  R --> QA
  QA --> PG

  QA -.-> OBS
  AS -.-> OBS
  K8S -.-> CA
  K8S -.-> QA
  SEC -.-> CA
  SEC -.-> QA
