flowchart TB
  A["1. apply-service commit\nversion=N, outbox row"] --> B["2. outbox-relay\nPUBLISH + XADD"]
  B --> C{"3. Pub/Sub потерян\n(рестарт/сеть/backpressure)?"}
  C -- Нет --> D["Обычная инвалидация query-api"]
  C -- Да --> E["4. Детект gap\nredis_stream_lag / startup replay"]
  E --> F["5. XREADGROUP из stream"]
  F --> G{"6. event.version > localVersion?"}
  G -- Нет --> H["Пропустить дубликат\nXACK"]
  G -- Да --> I["7. Single-flight full reload\n+ atomic swap"]
  I --> J["8. XACK\nобновить localVersion"]
  J --> K["Периодическая сверка\nс dictionary_meta.version"]

  L["Результат:\nкэш догоняется автоматически\nбез ручного вмешательства"] -.-> J
  M["Строгие чтения не stale:\nX-Min-Version и 409 при недокоммите"] -.-> K
